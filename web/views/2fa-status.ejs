<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <main>
        <div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0"><i class="fas fa-shield-alt"></i> Two-Factor Authentication Status</h3>
                </div>
                <div class="card-body">
                    <% if (twoFactorEnabled) { %>
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle"></i> Two-Factor Authentication is <strong>enabled</strong>
                        </div>

                        <div class="card mb-3">
                            <div class="card-body">
                                <h5><i class="fas fa-key"></i> Backup Codes</h5>
                                <p>You have <strong><%= backupCodesCount %></strong> backup codes remaining.</p>
                                <% if (backupCodesCount < 3) { %>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> You're running low on backup codes. Consider regenerating them.
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <h5>Manage 2FA</h5>

                        <!-- Regenerate Backup Codes -->
                        <div class="card mb-3">
                            <div class="card-body">
                                <h6><i class="fas fa-sync"></i> Regenerate Backup Codes</h6>
                                <p class="text-muted">Generate new backup codes. This will invalidate your old codes.</p>
                                <form id="regenerateForm">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="regenerateToken"
                                               placeholder="Enter 6-digit code" maxlength="6" required>
                                        <button class="btn btn-warning" type="submit">
                                            <i class="fas fa-sync"></i> Regenerate
                                        </button>
                                    </div>
                                </form>
                                <div id="regenerateResult" class="mt-2"></div>
                                <div id="newBackupCodes" class="mt-3" style="display: none;">
                                    <div class="alert alert-warning">
                                        <h6>New Backup Codes:</h6>
                                        <div class="backup-codes bg-light p-3 rounded" id="newCodesContainer"></div>
                                        <button class="btn btn-sm btn-primary mt-2" onclick="copyNewBackupCodes()">
                                            <i class="fas fa-copy"></i> Copy All Codes
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Disable 2FA -->
                        <div class="card mb-3 border-danger">
                            <div class="card-body">
                                <h6 class="text-danger"><i class="fas fa-times-circle"></i> Disable 2FA</h6>
                                <p class="text-muted">Remove two-factor authentication from your account.</p>
                                <form id="disableForm">
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="disableToken"
                                               placeholder="Enter 6-digit code" maxlength="6" required>
                                        <button class="btn btn-danger" type="submit">
                                            <i class="fas fa-times"></i> Disable 2FA
                                        </button>
                                    </div>
                                </form>
                                <div id="disableResult" class="mt-2"></div>
                            </div>
                        </div>

                    <% } else { %>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle"></i> Two-Factor Authentication is <strong>disabled</strong>
                        </div>

                        <p>Protect your account with an extra layer of security. Enable 2FA to require both your password and a verification code from your phone.</p>

                        <a href="/auth/2fa/setup" class="btn btn-success">
                            <i class="fas fa-shield-alt"></i> Enable 2FA
                        </a>
                    <% } %>

                    <div class="mt-4">
                        <a href="/dashboard" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Regenerate backup codes
document.getElementById('regenerateForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const token = document.getElementById('regenerateToken').value;
    const resultDiv = document.getElementById('regenerateResult');

    try {
        const response = await fetch('/auth/2fa/regenerate-backup-codes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token })
        });

        const data = await response.json();

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ${data.message}
            </div>`;

            // Display new backup codes
            if (data.backupCodes) {
                const codesContainer = document.getElementById('newCodesContainer');
                codesContainer.innerHTML = data.backupCodes.map(code =>
                    `<code class="d-block mb-1">${code}</code>`
                ).join('');
                document.getElementById('newBackupCodes').style.display = 'block';
                document.getElementById('regenerateForm').style.display = 'none';
            }
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> ${data.message}
            </div>`;
        }

        document.getElementById('regenerateToken').value = '';
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> An error occurred. Please try again.
        </div>`;
    }
});

// Disable 2FA
document.getElementById('disableForm')?.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!confirm('Are you sure you want to disable 2FA? This will make your account less secure.')) {
        return;
    }

    const token = document.getElementById('disableToken').value;
    const resultDiv = document.getElementById('disableResult');

    try {
        const response = await fetch('/auth/2fa/disable', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ token })
        });

        const data = await response.json();

        if (data.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">
                <i class="fas fa-check-circle"></i> ${data.message}
            </div>`;

            // Reload page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i> ${data.message}
            </div>`;
        }

        document.getElementById('disableToken').value = '';
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> An error occurred. Please try again.
        </div>`;
    }
});

function copyNewBackupCodes() {
    const codes = document.querySelectorAll('#newCodesContainer code');
    let text = 'Valknut 2FA Backup Codes:\n\n';
    codes.forEach(code => {
        text += code.textContent + '\n';
    });

    navigator.clipboard.writeText(text).then(() => {
        const btn = event.target;
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        setTimeout(() => {
            btn.innerHTML = originalHTML;
        }, 2000);
    });
}
</script>

    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
</body>
</html>
