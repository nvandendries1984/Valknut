<!DOCTYPE html>
<html lang="<%= currentLang %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/navbar') %>
    <%- include('partials/2fa-alert') %>

    <main>
        <div class="container py-4">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="d-flex align-items-center">
                    <% if (guild.icon) { %>
                        <img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png"
                             alt="<%= guild.name %>" class="rounded me-3" width="64" height="64">
                    <% } else { %>
                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-3"
                             style="width: 64px; height: 64px; font-size: 2rem;">
                            <%= guild.name.charAt(0) %>
                        </div>
                    <% } %>
                    <div>
                        <h1 class="h2 mb-1"><%= guild.name %></h1>
                        <p class="text-muted mb-0">Server ID: <%= guild.id %></p>
                    </div>
                </div>
                <a href="/dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    <%= __('guild.backToDashboard') %>
                </a>
            </div>

            <!-- Settings Section -->
            <div class="card bg-dark text-white border-secondary mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i><%= __('guild.settings') %></h5>
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="logChannelId" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>
                                    Log Channel ID
                                </label>
                                <input type="text" class="form-control" id="logChannelId" name="logChannelId"
                                       value="<%= guild.dbInfo.logChannelId || '' %>"
                                       placeholder="123456789012345678">
                                <div class="form-text">Channel where bot logs are sent</div>
                            </div>

                            <div class="col-md-4">
                                <label for="prefix" class="form-label">
                                    <i class="fas fa-terminal me-1"></i>
                                    Custom Prefix
                                </label>
                                <input type="text" class="form-control" id="prefix" name="prefix"
                                       value="<%= guild.dbInfo.settings?.prefix || '' %>"
                                       placeholder="! (default)">
                                <div class="form-text">Leave empty for default prefix</div>
                            </div>

                            <div class="col-md-4">
                                <label for="language" class="form-label">
                                    <i class="fas fa-language me-1"></i>
                                    Language
                                </label>
                                <select class="form-select" id="language" name="language">
                                    <option value="en" <%= guild.dbInfo.settings?.language === 'en' ? 'selected' : '' %>>English</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="fas fa-save me-2"></i>
                            <%= __('common.save') %>
                        </button>
                    </form>

                    <div id="saveMessage" class="alert mt-3 mb-0" style="display: none;"></div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card bg-dark text-white border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-3x mb-2 text-primary"></i>
                            <h3 class="mb-0"><%= guild.dbInfo.memberCount %></h3>
                            <p class="text-muted mb-0">Total Members</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark text-white border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-user-check fa-3x mb-2 text-primary"></i>
                            <h3 class="mb-0"><%= guild.users.length %></h3>
                            <p class="text-muted mb-0">Registered Vikings</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark text-white border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar fa-3x mb-2 text-primary"></i>
                            <h5 class="mb-0"><%= new Date(guild.dbInfo.joinedAt).toLocaleDateString('en-US') %></h5>
                            <p class="text-muted mb-0">Bot Added</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <% if (guild.users.length > 0) { %>
                <div class="card bg-dark text-white border-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Registered Vikings (Last 50)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Avatar</th>
                                        <th>Username</th>
                                        <th>Roles</th>
                                        <th>User ID</th>
                                        <th>Registered at</th>
                                        <th>Onboarding</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% guild.users.forEach(user => { %>
                                        <tr>
                                            <td>
                                                <img src="<%= user.avatarURL %>" alt="<%= user.username %>"
                                                     class="rounded-circle" width="32" height="32">
                                            </td>
                                            <td>
                                                <strong><%= user.globalName || user.username %></strong>
                                                <% if (user.bot) { %>
                                                    <span class="badge bg-info ms-2">BOT</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (user.roles && user.roles.length > 0) { %>
                                                    <% user.roles.forEach(role => { %>
                                                        <span class="badge me-1" style="background: <%= role.color %>;">
                                                            <%= role.name %>
                                                        </span>
                                                    <% }); %>
                                                <% } else { %>
                                                    <span class="text-muted">No roles</span>
                                                <% } %>
                                            </td>
                                            <td><code><%= user.userId %></code></td>
                                            <td><%= new Date(user.registeredAt).toLocaleString('en-US') %></td>
                                            <td>
                                                <% if (user.onboarding && user.onboarding.name) { %>
                                                    <button class="btn btn-sm btn-primary" onclick="showOnboardingData('<%= user._id %>')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <script>
                                                        window.onboardingData = window.onboardingData || {};
                                                        window.onboardingData['<%= user._id %>'] = {
                                                            userId: '<%= user.userId %>',
                                                            username: '<%= user.username %>',
                                                            name: '<%= user.onboarding.name %>',
                                                            saga: '<%= user.onboarding.saga || "" %>',
                                                            dateOfBirth: '<%= user.onboarding.dateOfBirth || "" %>',
                                                            postcode: '<%= user.onboarding.postcode || "" %>',
                                                            woonplaats: '<%= user.onboarding.woonplaats || "" %>',
                                                            address: '<%= user.onboarding.address || "" %>',
                                                            phoneNumber: '<%= user.onboarding.phoneNumber || "" %>',
                                                            email: '<%= user.onboarding.email || "" %>',
                                                            year: '<%= user.onboarding.year || "" %>',
                                                            sagaLevel: '<%= user.onboarding.sagaLevel || "" %>',
                                                            dateRecruit: '<%= user.onboarding.dateRecruit ? user.onboarding.dateRecruit.toISOString().split("T")[0] : "" %>',
                                                            datumWarrior: '<%= user.onboarding.datumWarrior ? user.onboarding.datumWarrior.toISOString().split("T")[0] : "" %>',
                                                            punten: '<%= user.onboarding.punten || 0 %>',
                                                            strafpunten: '<%= user.onboarding.strafpunten || 0 %>',
                                                            strikes: '<%= user.onboarding.strikes || 0 %>',
                                                            notes: '<%= (user.onboarding.notes || "").replace(/'/g, "\\'").replace(/\n/g, "\\n") %>',
                                                            dateRegistered: '<%= user.onboarding.dateRegistered ? new Date(user.onboarding.dateRegistered).toLocaleDateString("en-US") : "" %>'
                                                        };
                                                    </script>
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Create/Edit Role Modal -->
        <!-- Removed: Roles are managed in Discord only -->

        <!-- Manage User Roles Modal -->
        <!-- Removed: Roles are managed in Discord only -->
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
const guildId = '<%= guild.id %>';

// Sync Discord roles
async function syncDiscordRoles() {
    const btn = document.getElementById('syncRolesBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Synchronizing...';

    try {
        const response = await fetch(`/api/guild/${guildId}/roles/sync`, {
            method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
            alert(`‚úì Roles synchronized!\n\nImported: ${data.imported}\nUpdated: ${data.updated}\nTotal: ${data.total}`);
            location.reload();
        } else {
            throw new Error(data.error || 'Sync failed');
        }
    } catch (error) {
        alert('‚úó Error synchronizing roles: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Settings form submission
document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const messageEl = document.getElementById('saveMessage');

    try {
        const response = await fetch('/api/guild/<%= guild.id %>/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            messageEl.className = 'alert alert-success mt-3 mb-0';
            messageEl.textContent = '‚úì Settings saved!';
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        } else {
            throw new Error('Failed to save');
        }
    } catch (error) {
        messageEl.className = 'alert alert-danger mt-3 mb-0';
        messageEl.textContent = '‚úó Error saving settings';
        messageEl.style.display = 'block';
    }
});

// Onboarding modal functions
function getSagaEmoji(saga) {
    const emojis = {
        'Beardserker': 'üßî',
        'Sideburn Soldier': 'üë®',
        'Moustache Militia': 'ü•∏',
        'Goatee Gladiator': 'üó°Ô∏è',
        'Whaler': 'üêã',
        'Shieldmaiden': 'üõ°Ô∏è'
    };
    return emojis[saga] || '';
}

function getSagaColor(saga) {
    const colors = {
        'Beardserker': '#8B4513',
        'Sideburn Soldier': '#4169E1',
        'Moustache Militia': '#9370DB',
        'Goatee Gladiator': '#DC143C',
        'Whaler': '#20B2AA',
        'Shieldmaiden': '#FFD700'
    };
    return colors[saga] || '#6c757d';
}

function showOnboardingData(userId) {
    const data = window.onboardingData[userId];
    if (!data) return;

    const modalHtml = `
        <div class="modal fade" id="onboardingModal" tabindex="-1">
            <div class="modal-dialog modal-xl">
                <div class="modal-content bg-dark text-white border-secondary">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">
                            <i class="fas fa-user-plus me-2"></i>
                            Details: ${data.username}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <form id="onboardingForm">
                        <div class="modal-body">
                            <h6 class="text-primary mb-3">Personal Information</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-user me-1"></i>Name
                                    </label>
                                    <input type="text" name="name" class="form-control bg-dark text-white border-secondary" value="${data.name}" placeholder="Enter name">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-flag me-1"></i>Saga
                                    </label>
                                    <select name="saga" class="form-select bg-dark text-white border-secondary">
                                        <option value="">Select Saga</option>
                                        <option value="Beardserker" ${data.saga === 'Beardserker' ? 'selected' : ''}>üßî Beardserker</option>
                                        <option value="Sideburn Soldier" ${data.saga === 'Sideburn Soldier' ? 'selected' : ''}>üë® Sideburn Soldier</option>
                                        <option value="Moustache Militia" ${data.saga === 'Moustache Militia' ? 'selected' : ''}>ü•∏ Moustache Militia</option>
                                        <option value="Goatee Gladiator" ${data.saga === 'Goatee Gladiator' ? 'selected' : ''}>üó°Ô∏è Goatee Gladiator</option>
                                        <option value="Whaler" ${data.saga === 'Whaler' ? 'selected' : ''}>üêã Whaler</option>
                                        <option value="Shieldmaiden" ${data.saga === 'Shieldmaiden' ? 'selected' : ''}>üõ°Ô∏è Shieldmaiden</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-home me-1"></i>Address
                                    </label>
                                    <input type="text" name="address" class="form-control bg-dark text-white border-secondary" value="${data.address || ''}" placeholder="Enter full address">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-map-pin me-1"></i>Postcode
                                    </label>
                                    <input type="text" name="postcode" class="form-control bg-dark text-white border-secondary" value="${data.postcode || ''}" placeholder="Enter postcode">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-city me-1"></i>City
                                    </label>
                                    <input type="text" name="woonplaats" class="form-control bg-dark text-white border-secondary" value="${data.woonplaats || ''}" placeholder="Enter city">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-calendar me-1"></i>Date of Birth
                                    </label>
                                    <input type="text" name="dateOfBirth" class="form-control bg-dark text-white border-secondary" value="${data.dateOfBirth || ''}" placeholder="DD-MM-YYYY">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-envelope me-1"></i>Email
                                    </label>
                                    <input type="email" name="email" class="form-control bg-dark text-white border-secondary" value="${data.email || ''}" placeholder="Enter email">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-phone me-1"></i>Phone Number
                                    </label>
                                    <input type="text" name="phoneNumber" class="form-control bg-dark text-white border-secondary" value="${data.phoneNumber || ''}" placeholder="Enter phone number">
                                </div>
                            </div>

                            <hr class="border-secondary">
                            <h6 class="text-success mb-3">Saga & Progress</h6>
                            <div class="row g-3 mb-4">
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-layer-group me-1"></i>Saga Level
                                    </label>
                                    <input type="number" name="sagaLevel" class="form-control bg-dark text-white border-secondary" value="${data.sagaLevel || ''}" placeholder="0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-calendar-plus me-1"></i>Recruit Date
                                    </label>
                                    <input type="date" name="dateRecruit" class="form-control bg-dark text-white border-secondary" value="${data.dateRecruit || ''}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-calendar-check me-1"></i>Warrior Date
                                    </label>
                                    <input type="date" name="datumWarrior" class="form-control bg-dark text-white border-secondary" value="${data.datumWarrior || ''}">
                                </div>
                            </div>

                            <hr class="border-secondary">
                            <h6 class="text-warning mb-3">Points & Statistics</h6>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-star me-1"></i>Points
                                    </label>
                                    <input type="number" name="punten" class="form-control bg-dark text-white border-secondary" value="${data.punten || 0}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Penalty Points
                                    </label>
                                    <input type="number" name="strafpunten" class="form-control bg-dark text-white border-secondary" value="${data.strafpunten || 0}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-bolt me-1"></i>Strikes
                                    </label>
                                    <input type="number" name="strikes" class="form-control bg-dark text-white border-secondary" value="${data.strikes || 0}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label text-muted">
                                        <i class="fas fa-comment me-1"></i>Notes
                                    </label>
                                    <textarea name="notes" class="form-control bg-dark text-white border-secondary" rows="3" placeholder="Enter notes">${data.notes || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer border-secondary">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-1"></i>Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('onboardingModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('onboardingModal'));
    modal.show();

    // Handle form submission
    document.getElementById('onboardingForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

        try {
            const response = await fetch('/api/guild/<%= guild.id %>/user/' + data.userId + '/onboarding', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Object.fromEntries(formData))
            });

            if (response.ok) {
                submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Saved!';
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-primary');

                setTimeout(() => {
                    modal.hide();
                    location.reload();
                }, 1500);
            } else {
                throw new Error('Failed to save');
            }
        } catch (error) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            alert('‚úó Error saving onboarding data');
        }
    });

    // Clean up modal after it's hidden
    document.getElementById('onboardingModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}
    </script>
</body>
</html>
