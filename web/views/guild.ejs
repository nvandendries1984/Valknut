<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('partials/navbar') %>

    <main>
        <div class="container py-4">
            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-start mb-4">
                <div class="d-flex align-items-center">
                    <% if (guild.icon) { %>
                        <img src="https://cdn.discordapp.com/icons/<%= guild.id %>/<%= guild.icon %>.png"
                             alt="<%= guild.name %>" class="rounded me-3" width="64" height="64">
                    <% } else { %>
                        <div class="bg-secondary rounded d-flex align-items-center justify-content-center me-3"
                             style="width: 64px; height: 64px; font-size: 2rem;">
                            <%= guild.name.charAt(0) %>
                        </div>
                    <% } %>
                    <div>
                        <h1 class="h2 mb-1"><%= guild.name %></h1>
                        <p class="text-muted mb-0">Server ID: <%= guild.id %></p>
                    </div>
                </div>
                <a href="/dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Terug
                </a>
            </div>

            <!-- Settings Section -->
            <div class="card bg-dark text-white border-secondary mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Server Instellingen</h5>
                </div>
                <div class="card-body">
                    <form id="settingsForm">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label for="logChannelId" class="form-label">
                                    <i class="fas fa-hashtag me-1"></i>
                                    Log Kanaal ID
                                </label>
                                <input type="text" class="form-control" id="logChannelId" name="logChannelId"
                                       value="<%= guild.dbInfo.logChannelId || '' %>"
                                       placeholder="123456789012345678">
                                <div class="form-text">Kanaal waar bot logs naartoe worden gestuurd</div>
                            </div>

                            <div class="col-md-4">
                                <label for="prefix" class="form-label">
                                    <i class="fas fa-terminal me-1"></i>
                                    Custom Prefix
                                </label>
                                <input type="text" class="form-control" id="prefix" name="prefix"
                                       value="<%= guild.dbInfo.settings?.prefix || '' %>"
                                       placeholder="! (standaard)">
                                <div class="form-text">Laat leeg voor standaard prefix</div>
                            </div>

                            <div class="col-md-4">
                                <label for="language" class="form-label">
                                    <i class="fas fa-language me-1"></i>
                                    Taal
                                </label>
                                <select class="form-select" id="language" name="language">
                                    <option value="en" <%= guild.dbInfo.settings?.language === 'en' ? 'selected' : '' %>>English</option>
                                    <option value="nl" <%= guild.dbInfo.settings?.language === 'nl' ? 'selected' : '' %>>Nederlands</option>
                                </select>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">
                            <i class="fas fa-save me-2"></i>
                            Opslaan
                        </button>
                    </form>

                    <div id="saveMessage" class="alert mt-3 mb-0" style="display: none;"></div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card bg-dark text-white border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-users fa-3x mb-2 text-primary"></i>
                            <h3 class="mb-0"><%= guild.dbInfo.memberCount %></h3>
                            <p class="text-muted mb-0">Totaal Leden</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark text-white border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-user-check fa-3x mb-2 text-primary"></i>
                            <h3 class="mb-0"><%= guild.users.length %></h3>
                            <p class="text-muted mb-0">Geregistreerde Users</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card bg-dark text-white border-secondary h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-calendar fa-3x mb-2 text-primary"></i>
                            <h5 class="mb-0"><%= new Date(guild.dbInfo.joinedAt).toLocaleDateString('nl-NL') %></h5>
                            <p class="text-muted mb-0">Bot Toegevoegd</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Section -->
            <% if (guild.users.length > 0) { %>
                <div class="card bg-dark text-white border-secondary">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Geregistreerde Users (Laatste 50)</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-dark table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Avatar</th>
                                        <th>Username</th>
                                        <th>Rollen</th>
                                        <th>User ID</th>
                                        <th>Geregistreerd op</th>
                                        <th>Onboarding</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% guild.users.forEach(user => { %>
                                        <tr>
                                            <td>
                                                <img src="<%= user.avatarURL %>" alt="<%= user.username %>"
                                                     class="rounded-circle" width="32" height="32">
                                            </td>
                                            <td>
                                                <strong><%= user.globalName || user.username %></strong>
                                                <% if (user.bot) { %>
                                                    <span class="badge bg-info ms-2">BOT</span>
                                                <% } %>
                                            </td>
                                            <td>
                                                <% if (user.roles && user.roles.length > 0) { %>
                                                    <% user.roles.forEach(role => { %>
                                                        <span class="badge me-1" style="background: <%= role.color %>;">
                                                            <%= role.name %>
                                                        </span>
                                                    <% }); %>
                                                <% } else { %>
                                                    <span class="text-muted">Geen rollen</span>
                                                <% } %>
                                            </td>
                                            <td><code><%= user.userId %></code></td>
                                            <td><%= new Date(user.registeredAt).toLocaleString('nl-NL') %></td>
                                            <td>
                                                <% if (user.onboarding && user.onboarding.name) { %>
                                                    <button class="btn btn-sm btn-primary" onclick="showOnboardingData('<%= user._id %>')">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <script>
                                                        window.onboardingData = window.onboardingData || {};
                                                        window.onboardingData['<%= user._id %>'] = {
                                                            username: '<%= user.username %>',
                                                            name: '<%= user.onboarding.name %>',
                                                            saga: '<%= user.onboarding.saga || "" %>',
                                                            dateOfBirth: '<%= user.onboarding.dateOfBirth || "" %>',
                                                            address: '<%= user.onboarding.address || "" %>',
                                                            phoneNumber: '<%= user.onboarding.phoneNumber || "" %>',
                                                            email: '<%= user.onboarding.email || "" %>',
                                                            year: '<%= user.onboarding.year || "" %>',
                                                            dateRegistered: '<%= user.onboarding.dateRegistered ? new Date(user.onboarding.dateRegistered).toLocaleDateString("nl-NL") : "" %>'
                                                        };
                                                    </script>
                                                <% } else { %>
                                                    <span class="text-muted">-</span>
                                                <% } %>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Create/Edit Role Modal -->
        <!-- Removed: Roles are managed in Discord only -->

        <!-- Manage User Roles Modal -->
        <!-- Removed: Roles are managed in Discord only -->
    </main>

    <%- include('partials/footer') %>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
const guildId = '<%= guild.id %>';

// Sync Discord roles
async function syncDiscordRoles() {
    const btn = document.getElementById('syncRolesBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Synchroniseren...';

    try {
        const response = await fetch(`/api/guild/${guildId}/roles/sync`, {
            method: 'POST'
        });

        const data = await response.json();

        if (response.ok) {
            alert(`‚úì Rollen gesynchroniseerd!\n\nGe√Ømporteerd: ${data.imported}\nBijgewerkt: ${data.updated}\nTotaal: ${data.total}`);
            location.reload();
        } else {
            throw new Error(data.error || 'Sync failed');
        }
    } catch (error) {
        alert('‚úó Fout bij synchroniseren van rollen: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = originalText;
    }
}

// Settings form submission
document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    const messageEl = document.getElementById('saveMessage');

    try {
        const response = await fetch('/api/guild/<%= guild.id %>/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            messageEl.className = 'alert alert-success mt-3 mb-0';
            messageEl.textContent = '‚úì Instellingen opgeslagen!';
            messageEl.style.display = 'block';

            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        } else {
            throw new Error('Failed to save');
        }
    } catch (error) {
        messageEl.className = 'alert alert-danger mt-3 mb-0';
        messageEl.textContent = '‚úó Fout bij opslaan van instellingen';
        messageEl.style.display = 'block';
    }
});

// Onboarding modal functions
function getSagaEmoji(saga) {
    const emojis = {
        'Beardserker': 'üßî',
        'Sideburn Soldier': 'üë®',
        'Moustache Militia': 'ü•∏',
        'Goatee Gladiator': 'üó°Ô∏è',
        'Whaler': 'üêã',
        'Shieldmaiden': 'üõ°Ô∏è'
    };
    return emojis[saga] || '';
}

function getSagaColor(saga) {
    const colors = {
        'Beardserker': '#8B4513',
        'Sideburn Soldier': '#4169E1',
        'Moustache Militia': '#9370DB',
        'Goatee Gladiator': '#DC143C',
        'Whaler': '#20B2AA',
        'Shieldmaiden': '#FFD700'
    };
    return colors[saga] || '#6c757d';
}

function showOnboardingData(userId) {
    const data = window.onboardingData[userId];
    if (!data) return;

    const modalHtml = `
        <div class="modal fade" id="onboardingModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark text-white border-secondary">
                    <div class="modal-header border-secondary">
                        <h5 class="modal-title">
                            <i class="fas fa-user-plus me-2"></i>
                            Onboarding: ${data.username}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted">
                                    <i class="fas fa-user me-1"></i>Naam
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.name}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">
                                    <i class="fas fa-flag me-1"></i>Saga
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-dark border-secondary" style="background-color: ${getSagaColor(data.saga)} !important;">
                                        ${getSagaEmoji(data.saga)}
                                    </span>
                                    <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.saga}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">
                                    <i class="fas fa-calendar me-1"></i>Geboortedatum
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.dateOfBirth || '-'}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">
                                    <i class="fas fa-calendar-check me-1"></i>Jaar
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.year || '-'}" readonly>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted">
                                    <i class="fas fa-home me-1"></i>Adres
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.address || '-'}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">
                                    <i class="fas fa-phone me-1"></i>Telefoonnummer
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.phoneNumber || '-'}" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted">
                                    <i class="fas fa-envelope me-1"></i>Email
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.email || '-'}" readonly>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted">
                                    <i class="fas fa-clock me-1"></i>Geregistreerd op
                                </label>
                                <input type="text" class="form-control bg-dark text-white border-secondary" value="${data.dateRegistered || '-'}" readonly>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-secondary">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Sluiten</button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Remove existing modal if any
    const existingModal = document.getElementById('onboardingModal');
    if (existingModal) {
        existingModal.remove();
    }

    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('onboardingModal'));
    modal.show();

    // Clean up modal after it's hidden
    document.getElementById('onboardingModal').addEventListener('hidden.bs.modal', function() {
        this.remove();
    });
}
    </script>
</body>
</html>
